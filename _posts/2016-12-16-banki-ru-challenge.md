---
layout: post
published: true
title: Визуализация данных сайта «Банки.ру»
date: '2016-12-16 00:00:00'
---
Лаборатория данных опубликовала [тестовое задание](http://datalaboratory.ru/events/designer-3/), и я за него взялся.

На сайте banki.ru есть таблица с народным рейтингом банков. Надо показать эти данные так, чтобы от них была польза. Мне было бы интересно узнать, где открыть депозит и куда вкладывать деньги, поэтому в качестве целевой аудитории выбрал физических лиц.

## Визуализирую

Первым делом визуализирую в гугльдоке:

![Визуализация Таниных данных в гугль-таблицах](/media/tanka-data-plot-google-doc.png)

В исходной таблице мало данных, но уже видны лидеры и тенденции
{:.caption}

Авангард уже давно в топе. У некоторых банков оценки выше, но существуют они не долго.

## Ищу данные

В рейтинге Банков.ру нет данных об оценках за разные продукты, поэтому Лаборатория наполнила [таблицу](https://docs.google.com/spreadsheets/d/1s6NB3kfwEJhiFY2ihUpFY4wc-19JUZiQX0M_O3e9oHE/edit) случайными значениями: 

```
=RANDBETWEEN($B2*0,7*100;IF(($B2*1,3)>5;500;$B2*1,3*100))/100
```

Искать логику и закономерности в таких данных как минимум странно :-) Попробую найти недостающую информацию. 

Спрашиваю техподдержку Банков.ру, почему переключатель продуктов не меняет рейтинг. Отвечают:

> Добрый день! Эти переключатели добавляют в рейтинг столбец с информацией о количестве отзывов по данному виду продуктов. Рейтинг один и не пересчитывается от продукта к продукту, однако в планах на будущее этот функционал есть.

А ещё в таблице Лаборатории данные с точностью до года, а на Банках.ру — до дня. Хочется скачать более полную статистику и сравнить.

Ищу данные на Банках.ру. Смотрю, что дольше грузится при запросе:<!--break-->

![Ищу данные](/media/finding-json.png)

Самая длинная зелёная полосочка — самый тяжёлый файл. Он-то нам и нужен
{:.caption}

Открываю самый большой файл — ура, это и есть наш JSON. Но там данные только одной лиги и только за один день.

Буду визуализировать только высшую лигу, то есть 50 банков с наибольшим количеством зачтенных отзывов за последние 365 дней. Перебираю все недели с 2005 по 2017 гг., для каждой скачиваю `.json`. Склеиваю в один файл:

```
cat index* >> banki.json 
```

В виме удаляю лишнее. Делаю уменьшенную версию файла данных для быстрых тестов. Для этого оставляю только каждую сотую строку:

```
awk 'NR == 1 || NR % 100 == 0' banki.json > banki_s2.json
```

Готово! 


## Ищу историю

Придумываю, какие данные выбрать и как их показать.

Из подкаста [Дата Сториз](datastori.es) узнал про [Табло](http://www.tableau.com/), пробую визуализировать в нём.

Вот, например, взаимозависимость количества оценок по разным продуктам. Каждая точка — банк в момент времени. Видно, что по перекредитованию отзывов меньше, чем по другим продуктам.

![banki-matrix.png](/media/banki-matrix.png)

Взаимозависимость количества оценок по разным продуктам
{:.caption}

История не вырисовывается. Возвращаюсь к графику зависимости средней оценки от времени.

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-23%20%D0%B2%2022.47.46.png)

В графиках дыры: вертикальные белые полосы и разрывы отдельных графиков
{:.caption}

В графиках дыры двух типов. Есть белые полосы, в эти периоды нет данных ни об одном банке. Даже на Банках.ру эти даты не работают:

![banki-data-holes.png]({{site.baseurl}}/media/banki-data-holes.png)
 
Ещё есть пробелы в данных отдельных банков, например, Банка «Санкт-Петербург» (выделен чёрным). Эти дыры появляются, появляются, когда банк вылетает из высшей лиги. Информация о нём есть, но в других лигах.

## Качаю данные обо всех лигах

Скачиваю оставшиеся лиги и «заклеиваю» разрывы.

![]({{ site.baseurl }}/forestryio/images/banki-data-downloading.gif)

Каждая лига грузится 10 минут, поэтому скачиваю параллельно
{:.caption}

Из других лиг пришли новые банки, отфильтровываю их джаваскриптом.

## Рисую оценки продуктов

Хочу показать, как менялись оценки продуктов с течением времени. Для этого надо знать, как они вычисляются. Например, если общая оценка — среднее значение оценок по разным продкутам, то можно показать, как она из них складывается:

![]({{ site.baseurl }}/forestryio/images/banki-sketch1.jpg)

 Вверху графики всех банков. Выбрали один — видим внизу оценки продуктов
 {:.caption}

[В методике расчёта рейтинга banki.ru](http://www.banki.ru/static/bundles/Ratings/BaseRating/nr_methodology.doc) о продуктах не говорится. Иду на сайт и пишу тестовый отзыв.

![banki-test-response.png]({{site.baseurl}}/media/banki-test-response.png)

Можно выбрать оценку от 1 до 5 и любое количество оцениваемых продуктов. Значит, я могу менять общую оценку, не меняя оценки отдельных продуктов. Вариант со средним арифметическим отпадает, значит нельзя складывать оценки продуктов между собой, мой стримграф будет бессмысленным. Придётся показать линиями:

![banki-services.png]({{site.baseurl}}/media/banki-services.png)

Показываю оценки продуктов линями, а не стримграфом
{:.caption}

Придумываю что делать с длинными названиями:

![banki-different-title-length.png]({{site.baseurl}}/media/banki-different-title-length.png)


# Рисую количество отзывов

Интересно увидеть, как число отзывов влияет на оценку и рейтинг. Любопытно посмотреть на наплывы отзывов, они могут говорить больших косяках в работе банка. Рисую график поступления новых отзывов в банк.

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-25%20%D0%B2%200.59.10.png)

Ого. Тач Банк в первую же неделю собрал 300 [негативных отзывов](http://www.banki.ru/services/responses/bank/touchbank/?page=24). А Ханты-Мансийский банк Открытие под Новый год получил 2000 отзывов, что уменьшило его оценку на четверть балла.

У некоторых банков число отзывов иногда уменьшается. Или глюк, или читерство, или функционал, про который я не знаю. Спрашиваю у поддержки: «Я запутался и не могу разобраться в логике народного рейтинга. Буду благодарен, если поможете: что должно произойти, чтобы у банка уменьшилось количество полученных отзывов? Как, например, у ОТП Банка 13 июля 2016 г». Отвечают:

> Летом 2016 года были разъединены ветки ОТП-Банка и Тач-Банка. В связи с этим отзывы по Тач-Банку мигрировали из ветки ОТП.

О, как! Не задумывался о таком. Значит, резкие приросты отзывов — не обязательно читерство, возможно, один банк съел другой и получил его отзывы. Здорово бы показать на графике, как банки разъединяются и сливаются, но в эту итерацию не успею.

Ещё тут видно, что в периоды, за которые данных нет, сайт работал и банки получали отзывы.

Пики получения отзывов приходятся на конец и начало года.

Если у банка мало отзывов, каждый новый резко меняет среднюю оценку, график ступенчатый. Постепенно скачки исчезают и график меняется плавно. Это видно на примере Транскапиталнефти:

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-25%20%D0%B2%201.58.26.png)

Как выбрать банк? Наводить мышку на график — можно, но попасть нелегко. И нельзя будет таскать бегунок по графику. Пользователь хочет просмотреть информацию по нескольким лучшим банкам, тогда удобнее будет выбрать его из списка а не ловить мышкой.

Выбираю продукты для отображения. Допустим, график для физических лиц, помогает им выбрать банк. Думаю, можно показать вклады и кредиты. Консультируюсь у экономиста и получаю ответ:

(Цель — помочь выбрать банк. У пользователя есть цель, например, взять кредит. В этом случае его не интересуют оценки за лизинг и прочее. )

> Люди физ. Оценивают? Тогда нужно будет выбрать те показатели, которые интересны обычным потребителям: потребительские кредиты, дебетовые карты и вклады. Я имела ввиду вклады физ. Лиц в предыдущем сообщении

> Активы обычному потребителю ничего не сажут

Класс, сравним по трём продуктам.

С другой стороны, клик — очень неудобно. Чтобы просмотреть информацию по каждому банку, надо все прокликать. Фу. Лучше отказаться от бегунка. Он не так нужен, потому что значения оценок не

Удобно будет показать простыню превьюшек банков, по клику покажем инфу. Думаю, что рассказать о банке в превьюшке. Может показать мини-график зависимости оценки за вклад от оценки за кредит? Тогда будет красиво

Но непонятно, почему тогда не показать бы график с зависимостью от времени. И общий рейтинг сразу там покажем.

Задумываюсь, как будет вести себя график в разных состояниях. Их оказалось много. Например, мне нужно показать на большом графике много банков, нужно способ который позволит получить более детальную информацию о каждом банки. Это можно сделать разными способами, например наводить мышку на нужный график, кликать по нужному графику, наводить мышку на миниатюру банка внизу, Щелкать поэта миниатюре. Если мы щелкаем по графику банка, Значит В интерфейсе появляется состояния. Пойти в состояние два: И одного банка не выбрано и выбран один банк. Можно было бы сделать и третье состояние с выбором нескольких банков, но это внесёт путаницу на график.

Чтобы проще было думать о Состояниях не упустить ничего важного, Придомовую матрицу взаимодействия с интерфейсом. Она получается трёхмерный: Состояние, действие, элемент. Каждая ячейка соответствует состояние в котором может находиться элемент при определённом действии. Исключение клетки рест. Для каждой такой клетки надо продумать состояние при взаимодействие отличными от РЕСТ с другими элементами других состояниях.

## Смотрю данные

Жалко, в данных нет их текстов, можно было бы показать настроение или проверить уникальность.

Хочется проверить зависимость рейтинга и средней оценки от времени. Делаю черновую диаграму из червяков. Видна линейная зависимость между величинами, но видны отклонения, например: рейтинги некоторых банков растут, хотя средняя оценка не меняется. Например, Совкомбанк в начале 2015 года:

![banki-anomaly-sovcombank.png](/media/banki-anomaly-sovcombank.png)

## Делаю выводы

Сама по себе средняя оценка не может быть критерием при выборе банка, важно ещё и количество отзывов. У Земского Банка твёрдая пятёрка, но всего три отзыва. Если выбирать между Тинькофф Банком и Модульбанком, то лучше остановиться на Тинькоффе, хоть и оценка у него ниже.

Если у банка мало отзывов, график у него ступенчатый.

Оценки со временем снижаются у всех. Может быть, банки в среднем стали хуже. Или люди критичнее. Или Банки.ру инзменили интерфейс написания отзыва.


![banki-rating.png]({{site.baseurl}}/media/banki-rating.png)

Рейтинг учитывает устаревание оценок, поэтому график плавнее, распределение ближе к гауссову
{:.caption}


![banki-complete-responses.png]({{site.baseurl}}/media/banki-complete-responses.png)

Больше всего отзывов пишут перед новым годом. Наверное, все снимают деньги, сталкиваются с очередями и уставшими сотрудниками банков. А новогодние праздники — время затишья. У Тинькофф Банка новый год меньше влияет на наплывы отзывов. Предположу, что он справляется с нагрузкой лучше других.



## Если бы было больше времени

Спарсил бы со страницы http://www.banki.ru/services/responses/list/ оценки для отзывов банков. Показал бы на графике кружочками пяти цветов полученные отзывы.

Показать, как банки разъединяются и сливаются.

Техподдержка подсказала, [где взять отзывы о продуктах](http://www.banki.ru/services/responses/list/product/deposits/?is_countable=on&json=1). Так что в следующей итерации можно взять реальные данные, сейчас уже не успею.

Скачал бы тексты отзывов с сайта и сделал динамическое облако тегов, которое покажет основные проблемы и достоинства банков на выбранную дату. Например, «очереди», «доставка карты», «нет банкоматов».
