---
layout: post
published: true
title: Визуализация данных сайта «Банки.ру»
date: '2016-12-16 00:00:00'
---
Лаборатория данных опубликовала [тестовое задание](http://datalaboratory.ru/events/designer-3/), и я за него взялся.

На сайте Банков.ру есть таблица с народным рейтингом. Надо показать её данные так, чтобы от них была польза. Мне было бы интересно узнать, где открыть депозит и куда вкладывать деньги, поэтому в качестве целевой аудитории я выбрал физических лиц.

## Визуализирую

Первым делом строю график в гугльдоке:

![Визуализация Таниных данных в гугль-таблицах](/media/tanka-data-plot-google-doc.png)

В исходной таблице мало данных, но уже видны закономерности
{:.caption}

Авангард давно в лидерах. У некоторых банков оценки выше, но существуют они недолго.

## Ищу данные

В рейтинге Банков.ру нет данных об оценках разных продуктов, поэтому Лаборатория наполнила [таблицу](https://docs.google.com/spreadsheets/d/1s6NB3kfwEJhiFY2ihUpFY4wc-19JUZiQX0M_O3e9oHE/edit) случайными значениями: 

```
=RANDBETWEEN($B2*0,7*100;IF(($B2*1,3)>5;500;$B2*1,3*100))/100
```

Искать логику и закономерности в таких данных как минимум странно :-) Попробую найти недостающую информацию. 

Спрашиваю техподдержку Банков.ру, почему переключатель продуктов не меняет рейтинг. Отвечают:

> Добрый день! Эти переключатели добавляют в рейтинг столбец с информацией о количестве отзывов по данному виду продуктов. Рейтинг один и не пересчитывается от продукта к продукту, однако в планах на будущее этот функционал есть.

Нет так нет. 

Лаборатория приготовила данные с точностью до года, а на Банках.ру их можно смотреть по дням. Хочется скачать более полную информацию и сравнить.

Ищу данные на Банках.ру. Смотрю, что дольше грузится при запросе:<!--break-->

![Ищу данные](/media/finding-json.png)

Самая длинная зелёная полосочка — самый тяжёлый файл. Он-то нам и нужен
{:.caption}

Открываю самый большой файл — ура, это и есть наш JSON. В нём данные о выбранной лиге в выбранный день.

Ограничусь «высшей лигой», то есть пятьюдесятью банками с наибольшим количеством зачтённых отзывов за последние 365 дней. Перебираю все недели с 2005 по 2017 гг., для каждой скачиваю `.json`. Склеиваю в один файл:

```
cat index* >> banki.json 
```

В виме удаляю лишнее. Делаю уменьшенную версию файла для быстрых тестов. Для этого оставляю только каждую сотую строку:

```
awk 'NR == 1 || NR % 100 == 0' banki.json > banki_s2.json
```

Готово! 


## Ищу историю

Придумываю, какие данные выбрать и как их показать.

Из подкаста [Дата Сториз](datastori.es) узнал про [Табло](http://www.tableau.com/), пробую визуализировать в нём.

Вот, например, взаимозависимость количества оценок по разным продуктам. Каждая точка — банк в момент времени. Видно, что по перекредитованию отзывов меньше, чем по другим продуктам.

![banki-matrix.png](/media/banki-matrix.png)

Взаимозависимость количества оценок по разным продуктам
{:.caption}


Хочется ещё проверить зависимость рейтинга и средней оценки от времени. Делаю черновую диаграмму из червяков. Видна линейная зависимость между величинами, но есть и отклонения. Например, рейтинг  Совкомбанка в 2015 году растёт, хотя средняя оценка не меняется:

![banki-anomaly-sovcombank.png](/media/banki-anomaly-sovcombank.png)

У Совкомбанка в 2015 году растёт рейтинг, но не средняя оценка
{:.caption}

Это возможно, потому что рейтинг учитывает устаревание отзывов. Возможно, Совкомбанк в 2015 г. получил много свежих двоек и троек, которые не повлияли на среднюю оценку, но подняли рейтинг.

История не вырисовывается. Возвращаюсь к графику зависимости средней оценки от времени.

## Качаю данные обо всех лигах

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-23%20%D0%B2%2022.47.46.png)

В графиках дыры: вертикальные белые полосы и разрывы отдельных графиков
{:.caption}

В графиках дыры двух типов. Есть белые полосы, в эти периоды нет данных ни об одном банке. Даже на Банках.ру эти даты не работают:

![banki-data-holes.png]({{site.baseurl}}/media/banki-data-holes.png)
 
Ещё есть пробелы в данных отдельных банков, например, Банка «Санкт-Петербург» (выделен чёрным). Эти дыры появляются, появляются, когда банк вылетает из высшей лиги. Информация о нём есть, но в других лигах.

Скачиваю оставшиеся лиги и «заклеиваю» разрывы.

![]({{ site.baseurl }}/forestryio/images/banki-data-downloading.gif)

Каждая лига грузится 10 минут, поэтому скачиваю параллельно
{:.caption}

Из других лиг пришли новые банки, отфильтровываю их джаваскриптом.

## Отображаю оценки продуктов

Хочу показать, как менялись оценки продуктов с течением времени. Для этого надо знать, как они вычисляются. Например, если общая оценка — среднее значение оценок по разным продуктам, то можно показать, как она из них складывается:

![]({{ site.baseurl }}/forestryio/images/banki-sketch1.jpg)

 Вверху графики всех банков. Выбрали один — видим внизу оценки продуктов
 {:.caption}

[В методике расчёта рейтинга](http://www.banki.ru/static/bundles/Ratings/BaseRating/nr_methodology.doc) о продуктах не говорится. Иду на сайт и пишу тестовый отзыв.

![banki-test-response.png]({{site.baseurl}}/media/banki-test-response.png)

При написании отзыва на Банках.ру люди выбирают от 0 до 12 продуктов
{:.caption}

Можно выбрать оценку от 1 до 5 и любое количество оцениваемых продуктов. Значит, оценки продуктов нельзя складывать между собой, стримграф будет бессмысленным. Нарисую линиями:

![banki-product-lines.png]({{site.baseurl}}/media/banki-product-lines.png){: style="width: auto;"}

Показываю оценки продуктов линями, а не стримграфом
{:.caption}


## Отображаю число отзывов

Средняя оценка не поможет выбрать банк, если неизвестно, сколько человек проголосовало. Наплывы отзывов могут говорить косяках в работе банка. Строю графики количества отзывов:

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-25%20%D0%B2%200.59.10.png)

Аномалия Ханты-Мансийского банка: под новый год он получил 2000 отзывов
{:.caption}

Сразу вижу аномалии. Тач Банк в первую же неделю собрал 300 [негативных отзывов](http://www.banki.ru/services/responses/bank/touchbank/?page=24). А Ханты-Мансийский банк Открытие под Новый год получил 2000 отзывов, что уменьшило его оценку на четверть балла.

У некоторых банков число отзывов иногда уменьшается. Или глюк, или читерство, или функционал, про который я не знаю. Спрашиваю у поддержки: «Я запутался и не могу разобраться в логике народного рейтинга. Буду благодарен, если поможете: что должно произойти, чтобы у банка уменьшилось количество полученных отзывов? Как, например, у ОТП Банка 13 июля 2016 г». Отвечают:

> Летом 2016 года были разъединены ветки ОТП Банка и Тач Банка. В связи с этим отзывы по Тач Банку мигрировали из ветки ОТП.

О, как! Не задумывался о таком. Значит, и резкие приросты отзывов — не обязательно читерство. Здорово бы показать на графике, как банки разъединяются и сливаются, но в эту итерацию не успею.

Скачки графиков после «белых дыр» говорят о том, что сайт Банки.ру в это время работал и люди писали отзывы.

Если у банка мало отзывов, каждый новый резко меняет среднюю оценку, график ступенчатый. С ростом числа рецензий скачки исчезают и график становится плавным.


## Выбираю продукты для отображения

Мне, как представителю целевой аудитории, интересно знать оценки банков по вкладам. Спрашиваю у знакомого экономиста, какие продукты будет интересно сравнить. Получаю ответ:

> Физлица оценивают? Тогда нужно будет выбрать те показатели, которые им интересны: кредиты, дебетовые карты и вклады. Активы обычному потребителю ничего не скажут

Класс, сравним по трём продуктам.

## Улучшаю графики

Сотня графиков — слишком много. Они скачут и путаются, выходит неразбериха. Надо показать только некоторые, но тогда пропадёт полнота картины. Проблему решает «скользящее окно»: видны все графики сразу, жирным выделены лишь те, превьюшки которых видны на экране. Показал паре испытуемых, они 
разобрались с этим нестандартным элементом управления без подсказок.

Клик по графику слева прокручивает правую часть экрана так, чтобы превьюшка банка попала в зону видимости.

![banki-gif.gif]({{site.baseurl}}/media/banki-gif.gif){:.border}

Интерактивная визуализация народных оценок банков
{:.caption}

![banki-timelapse2.gif]({{site.baseurl}}/media/banki-timelapse2.gif){:.border}

Таймлапс работы
{:.caption}



## Делаю выводы

Сама по себе средняя оценка не может быть критерием при выборе банка. У Земского Банка твёрдая пятёрка, но всего три отзыва. Если выбирать между Тинькофф Банком и Модульбанком, то лучше остановиться на Тинькоффе, хоть и оценка у него ниже.  Оценить популярность банка можно по форме графика: если отзывов мало, линия будет ступенчатой:

![banki-few-responses.png]({{site.baseurl}}/media/banki-few-responses.png){:style="width: auto;"}

У Почты Банка в начале 2013 года отзывов мало, график ступенчатый. В 2015 году их становится больше и ступеньки сглашиваются.
{:.caption}

Важно знать не только среднюю оценку, но и количество оценок и их актуальность. Эту проблему решает рейтинг.

![banki-rating.png]({{site.baseurl}}/media/banki-rating.png)

Рейтинг учитывает устаревание оценок, поэтому график плавнее, распределение ближе к гауссову
{:.caption}

Такое ощущение, что алгоритм расчёта рейтинга со временем меняется. Со временем он «подтягивает» все банки к некоторому значению, но значение это от года к году разное. Хочется перепроверить.

Сумма средних оценок всех банков со временем уменьшается. Может быть, банки стали хуже, или люди критичнее. Или Банки.ру изменили интерфейс написания отзыва.

![banki-complete-responses.png]({{site.baseurl}}/media/banki-complete-responses.png)

Динамика отзывов обо всех банках
{:.caption}

Больше всего отзывов пишут перед новым годом. Наверное, все снимают деньги, сталкиваются с очередями и уставшими сотрудниками банков. А новогодние праздники — время затишья. У Тинькофф Банка новый год меньше влияет на наплывы отзывов. Предположу, что он справляется с нагрузкой лучше других.

![banki-vtb-anomaly.png]({{site.baseurl}}/media/banki-vtb-anomaly.png)

ВТБ Банк Москвы получал не больше десяти отзывов в неделю. 28 мая 2016 года получил четыре тысячи
{:.caption}

Резкие скачки количества отзывов говорят о перерасчёте голосов при слиянии или разделении банков.


## Если бы было больше времени

Хочу улучшить проект. Например, так:

* заменить случайные значения оценок продуктов на настоящие, [я их нашёл](http://www.banki.ru/services/responses/list/).
* Сделать рейтинги по продуктам, добавить переключатель для выбора нужного продкута.
* Показать, сколько и каких оценок банк получил на каждой неделе. Для этого раскрасить червяков: красный пиксель — отзыв с одним баллом, зелёный — с пятью.
* Показать разъединения и поглощения банков. Автоматизировать поиск таких банков сравнением приростов рейтинга.
* Проверить правильность рейтинга Банков.ру, пересчитав оценки банков в рейтинг по их формуле. Сравнить графики.
* Из текстов отзывов сделать динамическое облако тегов. Навёл мышку на банк и читаешь, что про него чаще пишут. Например, «очереди», «нет банкоматов» и пр.
* Написать серверное приложение, которое будет регулярно скачивать свежие данные с Банков.ру.

Исправить ошибки:

* неправильные оценки по продуктам. Они должны показывать состояние банка на текущий день.
* Нужные графики не выделяются, пока не поскроллишь.

Доработать интерфейс:

* добавить возможность сравнить банки. Нажимаю на банк — он залипает и остаётся чёрным, даже когда я убираю с него мышку.
* Расширить зону клика у графиков. По тонкой линии сложно попасть мышкой, надо добавить более широкую прозрачную подложку.
* Сделать макет адаптивным, сейчас только на макбуке хорошо смотрится.
* Показать крутилку, пока данные грузятся.
* Добавить социальные кнопки.
* Показать бегунки. Двигаю мышку по большому графику, на ней двигается бегунок с датой, оценкой и числом отзывов. В превьюшках при этом синхронно двигаются маленькие бегунки и обновляются оценки:

[![banki-mockup-003.png]({{site.baseurl}}/media/banki-mockup-003.png){:.border}]({{site.baseurl}}/media/banki-mockup-003.png)

Бегунки подскажут, что толщина линии означает количество отзывов
{:.caption}

Ещё можно сделать визуализацию, где атомы — отзывы, а не банки. Можно будет сравнить карты отзывов для разных банков и продуктов, могут обнаружиться любопытные истории и закономерности.


[banki.dianov.org](http://banki.dianov.org){:.btn}

