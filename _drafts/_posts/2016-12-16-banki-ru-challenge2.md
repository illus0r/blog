---
title: "Визуализация данных сайта «Банки.ру»"
date: '2016-12-16 00:00:00'
layout: post
published: true
---
Лаборатория данных опубликовала [тестовое задание](http://datalaboratory.ru/events/designer-3/), я с радостью за него взялся.

<span style="letter-spacing: 0.01em;">На сайте banki.ru есть таблица с народным рейтингом банков. Надо показать эти данные так, чтобы от них была польза. Мне было бы интересно узнать, где открыть депозит и куда вкладывать деньги, поэтому в качестве целевой аудитории выбрал физических лиц.</span>

## Предварительная визуализация

В исходной таблице нет данных об оценках за разные услуги, поэтому [в предлагаемой таблице](https://docs.google.com/spreadsheets/d/1s6NB3kfwEJhiFY2ihUpFY4wc-19JUZiQX0M_O3e9oHE/edit) часть данных придумана: `=RANDBETWEEN($B2*0,7*100;IF(($B2*1,3)>5;500;$B2*1,3*100))/100` Первым делом визуализирую в екселе:

![Визуализация Таниных данных в гугль-таблицах](%7B%7Bsite.baseurl%7D%7D/media/tanka-data-plot-google-doc.png)

Видно, что Авангард уже давно в топе. А некоторые банки успешны, но не долго. 

Захотелось посмотреть зависимость одних оценок от других. Тогда можно сказать, у каких банков какая специализация и как она менялась. Например, можно посмотреть оценки по кредитам для физических и юридических лиц. Попробовал сделать это [на РАВе](http://app.raw.densitydesign.org/), вышло интересно, видно что разброс есть. Каждый банк должен был стать червячком, но не хватило возможностей платформы.

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-16%20%D0%B2%2011.56.18.png)

## Ищу данные

В Таниных данных фейковые рейтинги по услугам (потому что на сайте банка эта информация недоступна). Пишу в техподдержку об ошибке на сайте. Отвечают:

> Добрый день! Эти переключатели добавляют в рейтинг столбец с информацией о количестве отзывов по данному виду продуктов. Рейтинг один и не пересчитывается от продукта к продукту, однако в планах на будущее этот функционал есть.

Нет так нет, возьму фейковые.

Ещё у Тани данные с точностью до года, хотя на сайте можно смотреть статистику по дням. Хочется скачать данные с сайта и сравнить. Ищу данные на странице. Для этого смотрю, что грузится на странице при смене запроса.

![Ищу данные](%7B%7Bsite.baseurl%7D%7D/media/finding-json.png)

Открываю самый большой файл — ура, нашёл. Но там не всё, только то, что касается выбранной категории банков на выбранную дату. Зато вся информация об услугах в одном месте.

Визуализировать буду только одну категорию. Ту, которая выбрана Таней. А даты придётся прочесать все, с 2005 по 2017 гг. Автоматизируем это!

Гуглю, как вывести все даты в указанном интервале. Данные из скрипта перенаправляю на вход `wget`а. Через 10 минут я счастливый обладатель 4440 файлов.

![banki-data-downloading.gif](%7B%7Bsite.baseurl%7D%7D/media/banki-data-downloading.gif)

Надо посмотреть, что там за данные. Для этого склеить в один `csv`:

```
cat index* >> banki.csv
```

И выкинуть лишее в виме. Этот регексп оставит только значения переменных, разделит их запятыми: `:%s!.\{-\}:"*\(\d*\(\.\d*\)*\(\-\d*\)*\(false\)*\)"*!\1, !g`. А первую строчку дублируем и сделаем из неё заголовок `:s:"\(.\{-\}\)".\{-\},:\1, :g`

Долго возился с джейсоном, в итоге решил не конвертировать его в ЦСВ вообще. Попробую читать данные сразу из него.

Параллельно из подкаста Дата Сториз узнал про Табло, попробовал визуализировать в нём. Инструмент очень клёвый для быстрого просмотра данных и проблых визуализаций, но часто натыкаюсь на вещи, которые не знаю, как сделать. Вот, например, зависимость оценок по услугам друг от друга. Можно узнать, что самые крутые банки фейлят в перекредитовании.

![banki-matrix.png](%7B%7Bsite.baseurl%7D%7D/media/banki-matrix.png)

Возвращаюсь к ДЗ. Делаю уменшенную версию гигантского файла для быстрых тестов. Для этого оставляю только каждую сотую строку:

```
awk 'NR == 1 || NR % 100 == 0' banki.json > banki_s2.json
```

Параллельно придумываю, как организовать данные. Первая мысль — график рейтинга от времени.

В данных дыры, потому что я спарсил рейтинг 50 топовых банков. Но текущие лидеры иногда вылетали из этого рейтинга и попадали на другие страницы. Приходится Чтобы дырки в рейтигах банков заклеить» Это 50 топовых банков, может быть, дыры появляются, когда банк вываливается из топа? Тогда недостающие данные можно взять из другх, не топовых таблиц. Проверяю, но нет, банки в топе больше нигде не повторяются. В некоторых интервалах данных по ним нет: `"ratingData": [],`

Цель — помочь выбрать банк. У пользователя есть цель, например, взять кредит. В этом случае его не интересуют оценки за лизинг и прочее. Решаю показать, как менялись оценки по услугам с течением времени. Я предположил, что общий рейтинг — среднее значение рейтингов по разным направлениям. Тогда можно показать, как рейтинг складывается из рейтингов по услугам. Красота!

Смотрю Танины данные. Среднее значение рейтингов по услугам не совпадает с общим рейтингом. Может ошибка в данных? [В методике расчёта рейтинга banki.ru](http://www.banki.ru/static/bundles/Ratings/BaseRating/nr_methodology.doc) про услуги не сказано. Иду на сайт и пишу отзыв Сбербанку. Можно выбрать оценку от 1 до 5 и любое количество оцениваемых услуг. Значит, я могу менять общий рейтинг, не влияя на рейтинги услуг. Вариант со средним арифметическим отпадает. А ещё нельзя складывать значения рейтингов услуг между собой, мой стримграф будет бессмысленным.

Кстати, рейтинг расчитывается по отзывам, влияние отзывов на рейтинг экспоненциально уменьшается с течением времени. Если бы мы могли показать на картинке отзывы, было бы круто. Например, любопытно посмотреть на наплывы отзывов, они могут говорить

*   больших косяках в его работе. Хотя, Не представляю, что должно произойти, чтобы я пошёл писать отызыв. Разве что выиграть приз, который они обещают автору лучшего отзыва.

![banki-reward.png](%7B%7Bsite.baseurl%7D%7D/media/banki-reward.png)

Такая акция должна вызвать наплыв отзывов на разные банки одновременно. Если отзывы посыпались на какой-то один, значит либо он очень посещаемый, либо это атака, либо он расстроил людей настролько, что они вспомнили про банки ру, не поленились зарегистрироваться и написать отзыв.

Названия банков получаю из исходных данных при помощи http://www.freeformatter.com/javascript-escape.html#ad-output

Как выбрать банк? Наводить мышку на график — можно, но попасть нелегко. И нельзя будет таскать бегунок по графику. Пользователь хочет просмотреть информацию по нескольким лучшим банкам, тогда удобнее будет выбрать его из списка а не ловить мышкой.

Выбираю услуги для отображения. Допустим, график для физических лиц, помогает им выбрать банк. Думаю, можно показать вклады и кредиты. Консультируюсь у экономиста и получаю ответ:

> Люди физ. Оценивают? Тогда нужно будет выбрать те показатели, которые интересны обычным потребителям: потребительские кредиты, дебетовые карты и вклады. Я имела ввиду вклады физ. Лиц в предыдущем сообщении

> Активы обычному потребителю ничего не сажут

Класс, сравним по трём услугам.

С другой стороны, клик — очень неудобно. Чтобы просмотреть информацию по каждому банку, надо все прокликать. Фу. Лучше отказаться от бегунка. Он не так нужен, потому что значения оценок не

Удобно будет показать простыню превьюшек банков, по клику покажем инфу. Думаю, что рассказать о банке в превьюшке. Может показать мини-график зависимости оценки за вклад от оценки за кредит? Тогда будет красиво

Но непонятно, почему тогда не показать бы график с зависимостью от времени. И общий рейтинг сразу там покажем.

Задумываюсь, как будет вести себя график в разных состояниях. Их оказалось много. Например, мне нужно показать на большом графике много банков, нужно способ который позволит получить более детальную информацию о каждом банки. Это можно сделать разными способами, например наводить мышку на нужный график, кликать по нужному графику, наводить мышку на миниатюру банка внизу, Щелкать поэта миниатюре. Если мы щелкаем по графику банка, Значит В интерфейсе появляется состояния. Пойти в состояние два: И одного банка не выбрано и выбран один банк. Можно было бы сделать и третье состояние с выбором нескольких банков, но это внесёт путаницу на график.

Чтобы проще было думать о Состояниях не упустить ничего важного, Придомовую матрицу взаимодействия с интерфейсом. Она получается трёхмерный: Состояние, действие, элемент. Каждая ячейка соответствует состояние в котором может находиться элемент при определённом действии. Исключение клетки рест. Для каждой такой клетки надо продумать состояние при взаимодействие отличными от РЕСТ с другими элементами других состояниях.

## Смотрю данные

Хочется проверить зависимость рейтинга и средней оценки от времени. Делаю черновую диаграму из червяков. Видна линейная зависимость между величинами, но видны отклонения, например: рейтинги некоторых банков растут, хотя средняя оценка не меняется. Например, Совкомбанк в начале 2015 года: ![banki-anomaly-sovcombank.png](%7B%7Bsite.baseurl%7D%7D/media/banki-anomaly-sovcombank.png)

*   [ ] При наведении на график превьюшки должна появляться линейка на всех графиках первьюшках.