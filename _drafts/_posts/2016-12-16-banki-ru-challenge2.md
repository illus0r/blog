---
title: "Визуализация данных сайта «Банки.ру»"
date: '2016-12-16 00:00:00'
layout: post
published: true
---
Лаборатория данных опубликовала [тестовое задание](http://datalaboratory.ru/events/designer-3/), я с радостью за него взялся.

<span style="letter-spacing: 0.01em;">На сайте banki.ru есть таблица с народным рейтингом банков. Надо показать эти данные так, чтобы от них была польза. Мне было бы интересно узнать, где открыть депозит и куда вкладывать деньги, поэтому в качестве целевой аудитории выбрал физических лиц.</span>

## Визуализирую

В исходной таблице нет данных об оценках за разные услуги, поэтому [в предлагаемой таблице](https://docs.google.com/spreadsheets/d/1s6NB3kfwEJhiFY2ihUpFY4wc-19JUZiQX0M_O3e9oHE/edit) часть данных придумана: `=RANDBETWEEN($B2*0,7*100;IF(($B2*1,3)>5;500;$B2*1,3*100))/100` Первым делом визуализирую в екселе:

![Визуализация Таниных данных в гугль-таблицах](%7B%7Bsite.baseurl%7D%7D/media/tanka-data-plot-google-doc.png)

Видно, что Авангард уже давно в топе. А некоторые банки успешны, но не долго.

## <span style="color: rgb(40, 40, 40); letter-spacing: 0.01em;">Ищу данные</span>

Искать логику в заведомо рандомных значениях как минимум странно. Надо попробовать найти данные получше. Пишу в техподдержку Банков.ру об ошибке на сайте. Отвечают:

> Добрый день! Эти переключатели добавляют в рейтинг столбец с информацией о количестве отзывов по данному виду продуктов. Рейтинг один и не пересчитывается от продукта к продукту, однако в планах на будущее этот функционал есть.

<span style="letter-spacing: 0.01em;">Исходные данные с точностью до года, хотя на сайте можно смотреть статистику по дням. Хочется скачать данные с сайта и сравнить. Ищу данные на странице. Смотрю, что грузится при запросе.</span>

![Ищу данные](%7B%7Bsite.baseurl%7D%7D/media/finding-json.png)

Открываю самый большой файл — ура, это и есть наш JSON. Но там данные только одной лиги и только за один день.

Решаю визуализировать буду только высшую лигу, то есть 50 банков с наибольшим количеством зачтенных отзывов за последние 365 дней. Потому что в исходной таблице именно они.

<span style="letter-spacing: 0.01em;" class="">Перебираю все даты с 2005 по 2017 гг., для каждой скачиваю `.json`</span>. <span style="letter-spacing: 0.01em;">Склеиваю в один файл</span><span style="letter-spacing: 0.01em;">:</span>

```
cat index* >> banki.json 
```

В виме удаляю лишнее. Готово!

## <span style="letter-spacing: 0.01em;">Визуализирую</span>

<span style="letter-spacing: 0.01em;" class="">Захотелось посмотреть зависимость одних оценок от других. Тогда можно сказать, у каких банков какая специализация и как она менялась. Например, можно посмотреть оценки по кредитам для физических и юридических лиц. Попробовал сделать это [на РАВе](http://raw.densitydesign.org/), вышло интересно, видно что разброс есть.</span>

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-16%20%D0%B2%2011.56.01-1.png)

<span style="letter-spacing: 0.01em; background-color: rgb(255, 255, 255);" class="">Каждый банк должен был стать червячком, но не хватило возможностей платформы.</span>

Из подкаста [Дата Сториз](datastori.es) <span style="letter-spacing: 0.01em;">узнал про</span> [Табло](http://www.tableau.com/)<span style="letter-spacing: 0.01em;" class="">, пробую визуализировать в нём. Инструмент клёвый для быстрого просмотра данных и пробных визуализаций, но часто натыкаюсь на вещи, которые не знаю, как сделать.</span>

<span style="letter-spacing: 0.01em;" class="">Вот, например, взаимозависимость количества оценок по разным услуга. Каждая точка — банк в момент времени. Видно, что по перекредитованию отзывов меньше, чем по другим услугам.</span>

![banki-matrix.png](%7B%7Bsite.baseurl%7D%7D/media/banki-matrix.png)

Возвращаюсь к ДЗ. Делаю уменьшенную версию файла данных для быстрых тестов. Для этого оставляю только каждую сотую строку:

```
awk 'NR == 1 || NR % 100 == 0' banki.json > banki_s2.json
```

Придумываю, как организовать данные. Первая мысль — график общей оценки от времени.

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-23%20%D0%B2%2022.47.46.png)

В данных дыры. Есть большие пробелы, для этих дат информации нет даже на сайте. Есть мелкие дырки в отдельных графиках, например, у банка «Санкт-Петербург» (выделен чёрным). Эти дыры появляются, если банк на время вылетает из высшей лиги. Информация по ним есть, но в других лигах.

## Ищу данные

Скачиваю все остальные лиги и «заклеиваю» разрывы.

![]({{ site.baseurl }}/forestryio/images/banki-data-downloading.gif)

Из других лиг пришли новые банки, оставляю лишь те, что попадали в высшую лигу.

## Рисую оценки по услугам

Хочу показать, как менялись оценки по услугам с течением времени. Может быть, общая оценка — среднее значение оценок по разным услугам? Тогда можно показать, как она из них складывается. Вверху графики всех банков. Выбрали один — видим декомпозицию внизу.

![]({{ site.baseurl }}/forestryio/images/banki-sketch1.jpg)

<span style="letter-spacing: 0.01em;">Смотрю исходную таблицу. Среднее значение рейтингов по услугам не совпадает с общим рейтингом. Может ошибка в данных?</span> [В методике расчёта рейтинга banki.ru](http://www.banki.ru/static/bundles/Ratings/BaseRating/nr_methodology.doc) <span style="letter-spacing: 0.01em;">об услугах не говорится. </span><span style="letter-spacing: 0.01em;">Иду на сайт и пишу тестовый отзыв. Можно выбрать оценку от 1 до 5 и любое количество оцениваемых услуг. Значит, я могу менять общую оценку, не меняя оценки отдельных услуг. Вариант со средним арифметическим отпадает, значит нельзя складывать оценки услуг между собой, мой стримграф будет бессмысленным. Ищу другой вариант.</span>

Кстати, рейтинг расчитывается по отзывам, влияние отзывов на рейтинг экспоненциально уменьшается с течением времени. Интересно увидеть, как число отзывов влияет на оценку и рейтинг. Любопытно посмотреть на наплывы отзывов, они могут говорить <span style="letter-spacing: 0.01em;">больших косяках в работе банка. Не представляю, что должно произойти, чтобы я пошёл писать отызыв. Единственное, что может подтолкнуть к этому — желание выиграть приз, который «Банки.ру» обещают автору лучшего отзыва:</span>

![banki-reward.png](%7B%7Bsite.baseurl%7D%7D/media/banki-reward.png)

Такая акция должна вызвать наплыв отзывов на разные банки одновременно. Если отзывы посыпались на какой-то один, значит либо он очень посещаемый, либо это атака, либо он расстроил людей настолько, что они вспомнили про Банки.ру, не поленились зарегистрироваться и написать отзыв.

Проверяю предположение: показываю график поступления новых отзывов в банк.

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-25%20%D0%B2%200.59.10.png)

Ого. <span style="letter-spacing: 0.01em;">Тач Банк в первую же неделю собрал 300 [негативных отзывов](http://www.banki.ru/services/responses/bank/touchbank/?page=24). А </span><span style="letter-spacing: 0.01em;">Ханты-Мансийский банк Открытие под Новый год получил 2000 отзывов, что уменьшило его оценку на четверть балла, к сожалению, посмотреть на эти отзывы нельзя.</span>

У некоторых банков число отзывов иногда уменьшается. Или глюк, или читерство, или функционал, про который я не знаю. Спрашиваю у поддержки: «Я запутался и не могу разобраться в логике народного рейтинга. Буду благодарен, если поможете: что должно произойти, чтобы у банка уменьшилось количество полученных отзывов? Как, например, у ОТП Банка 13 июля 2016 г». Отвечают:

> Летом 2016 года были разъединены ветки ОТП-Банка и Тач-Банка. В связи с этим отзывы по Тач-Банку мигрировали из ветки ОТП.

Интересно, можно было бы показать на графике, как банки разъединяются и сливаются.

Видим, что в периоды, за которые данных нет, сайт работал и банки получали отзывы. Жалко, в данных нет их текстов, можно было бы показать настроение или проверить уникальность.

<span style="letter-spacing: 0.01em;">Пики получения отзывов приходятся на конец и начало года.</span>

Если у банка мало отзывов, каждый новый резко меняет среднюю оценку. Постепенно скачки исчезают и график меняется плавно. Это видно на примере Транскапиталнефти:<span style="letter-spacing: 0.01em;"></span>

![]({{ site.baseurl }}/forestryio/images/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202016-12-25%20%D0%B2%201.58.26.png)

Названия банков получаю из исходных данных при помощи http://www.freeformatter.com/javascript-escape.html#ad-output

Как выбрать банк? Наводить мышку на график — можно, но попасть нелегко. И нельзя будет таскать бегунок по графику. Пользователь хочет просмотреть информацию по нескольким лучшим банкам, тогда удобнее будет выбрать его из списка а не ловить мышкой.

Выбираю услуги для отображения. Допустим, график для физических лиц, помогает им выбрать банк. Думаю, можно показать вклады и кредиты. Консультируюсь у экономиста и получаю ответ:

(Цель — помочь выбрать банк. У пользователя есть цель, например, взять кредит. В этом случае его не интересуют оценки за лизинг и прочее. )

> Люди физ. Оценивают? Тогда нужно будет выбрать те показатели, которые интересны обычным потребителям: потребительские кредиты, дебетовые карты и вклады. Я имела ввиду вклады физ. Лиц в предыдущем сообщении

> Активы обычному потребителю ничего не сажут

Класс, сравним по трём услугам.

С другой стороны, клик — очень неудобно. Чтобы просмотреть информацию по каждому банку, надо все прокликать. Фу. Лучше отказаться от бегунка. Он не так нужен, потому что значения оценок не

Удобно будет показать простыню превьюшек банков, по клику покажем инфу. Думаю, что рассказать о банке в превьюшке. Может показать мини-график зависимости оценки за вклад от оценки за кредит? Тогда будет красиво

Но непонятно, почему тогда не показать бы график с зависимостью от времени. И общий рейтинг сразу там покажем.

Задумываюсь, как будет вести себя график в разных состояниях. Их оказалось много. Например, мне нужно показать на большом графике много банков, нужно способ который позволит получить более детальную информацию о каждом банки. Это можно сделать разными способами, например наводить мышку на нужный график, кликать по нужному графику, наводить мышку на миниатюру банка внизу, Щелкать поэта миниатюре. Если мы щелкаем по графику банка, Значит В интерфейсе появляется состояния. Пойти в состояние два: И одного банка не выбрано и выбран один банк. Можно было бы сделать и третье состояние с выбором нескольких банков, но это внесёт путаницу на график.

Чтобы проще было думать о Состояниях не упустить ничего важного, Придомовую матрицу взаимодействия с интерфейсом. Она получается трёхмерный: Состояние, действие, элемент. Каждая ячейка соответствует состояние в котором может находиться элемент при определённом действии. Исключение клетки рест. Для каждой такой клетки надо продумать состояние при взаимодействие отличными от РЕСТ с другими элементами других состояниях.

## Смотрю данные

Хочется проверить зависимость рейтинга и средней оценки от времени. Делаю черновую диаграму из червяков. Видна линейная зависимость между величинами, но видны отклонения, например: рейтинги некоторых банков растут, хотя средняя оценка не меняется. Например, Совкомбанк в начале 2015 года:<span class="image-wrapper media-wrapper" contenteditable="false"></span>

![banki-anomaly-sovcombank.png](%7B%7Bsite.baseurl%7D%7D/media/banki-anomaly-sovcombank.png)

## Если бы было больше времени

Спарсил бы со страницы http://www.banki.ru/services/responses/list/ оценки для отзывов банков. Показал бы на графике кружочками пяти цветов полученные отзывы.

Показать, как банки разъединяются и сливаются.

Техподдержка подсказала, [где искать оценки по услугам](http://www.banki.ru/services/responses/list/product/deposits/?is_countable=on&json=1). Так что в следующей итерации можно взять реальные данные, сейчас уже не успею.

Скачал бы тексты отзывов с сайта и сделал динамическое облако тегов, которое покажет основные проблемы и достоинства банков на выбранную дату. Например, «очереди», «доставка карты», «нет банкоматов».