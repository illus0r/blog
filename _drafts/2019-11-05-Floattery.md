Женя Арутюнов предложил написать про устройство нашего паркового проекта Флоттери:

> Сколько там переменных, как они связаны, как влияют на форму. Что такое грамматика, какая она. Как из текста получается набор переменных.
> Как устроены все интеграции, как был устроен процесс совместной разработки.

Флоттери — это скорее искусство, чем сайт. Да, искусство бывает и на сайтах. Например, ХХХХХХ кодит интерактивные сайты публикует, а потом продаёт вместе с доменными именами.

Оооо, отвечаю.

## Вратце



- Секции поплавков вручную нарисованы в фигме
- Генеративная грамматика расставляет эти секции так, чтобы они соединялись друг с другом эллипсами одного размера.
- Текстовая строка используется для управления рандомизатором генеративной грамматики.
- Круги на воде и стрекозы — по сути тоже сегменты поплвка, их положение определяется грамматикой.

!Или так:

Поплавки собираются из заранее нарисованных секций. Не как попало, а в соответствии с правилами, описанными порождающей грамматикой. Она определяет разные варианты поплавков: какие в них типы секций, и в каком порядке они идут.

Последовательность получается рандомной, но эта рандомность зависит от содержимого текстового поля. Одинаковые значения будут рисовать одинаковые поплавки.

## Подробнее

Грамматику засунули в эксельку, чтобы работать вместе.
Чтобы её было быстрее вставлять в код, написал регулярное выражение для [вима](https://en.wikipedia.org/wiki/Vim_(text_editor)):
```
%s:\(<.\{-\}>\)\s*\(.*\)\s*$:\1\:\r- \2: | %s:\d\+_\d\+:<&>:g | %s:\s*$:: | %s:\s\+: :g
↑                                          ↑                    ↑           ↑         
1                                          2                    3           4
```
1. Разбивает каждое правило грамматики на две строки. В первой нетерминальный токен, во второй — во что он может превратиться.
2. Выбирает значения похожие на `16_16` и заворачивает их в треугольные скобки `<16_16>`.
3. Удаляет пробельные символы в концах строк.
4. Заменяет подряд идущие пробельные символы одним пробелом.


## Входной СВГ файл

А СВГ файл не простой. В нём каждый кусок поплавка лежит в своей группе, и имена этих групп, ох, не простые:

КАРТИНКА

Имена каждой группы в формате `p-16-32-100`. Первая цифра означает диаметр верхнего стыка. Вторая — нижнего. Третья — высота секции. Спойлер: высота игнорируется грамматикой, нужна только для рисования поплавка.


## Совместная работа над грамматикой

Каждый раз, когда Максим менял грамматику, я копировал ячейки из гуглдока в буфер обмена, вставлял в вим, выполнял эту комманду. И получал почти правильную грамматику, разве что стартовый символ ещё надо было разобрать на несколько строк-правил.

Ещё часть грамматики генерируется скриптом автоматически.

Для грамматики используем библиотеку [RiTa](https://rednoise.org/rita/reference/index.php).

Грамматика выбирает один из вариантов с одинаковой вероятностью.

Чтобы разрандомить, используем строку. Библиотека RiTa может сделать рандомность предсказуемой:

```
	RiTa.randomSeed(pseudoRandom);
```

На вход `randomSeed` принимает число, а на входе строка. Чтобы из неё сделать число, нашёл какую-то функцию на стековерфлоу, работает отлично:

```
function hashCode(str) {
	return str.split('').reduce((prevHash, currVal) =>
	  (((prevHash << 5) - prevHash) + currVal.charCodeAt(0))|0, 0)
  }
```
https://stackoverflow.com/a/34842797
{: .caption}

Вот сокращённый пример грамматики:
```
	<start>:
	- <type1>
	- <type2>
	- <type3>
	- <iceberg>
	<type1>:
	- <0_8> <8_8> <8_8> <8_32> <water> <32_32> <32_8> <8_0>
	<type2>:
	- <0_8> <8_8> <8_8> <8_64> <water> <64_64> <64_8> <8_0>
	<type3>:
	- <0_8> <8_8> <8_8> <8_128> <water> <128_128> <128_8> <8_0>
	<iceberg>:
	- <dragonfly> <0_32> <water> <32_128> <128_8> <8_0>
	<water>:
	- <0_0>
```
Разберём, что тут происходит.

`<start>` — это начальный токен. В начале есть только он, потом он превращается в другие токены в соответствии с правилами грамматики. Например, правило
```
	<start>:
	- <type1>
	- <type2>
	- <type3>
	- <iceberg>
```
означает, что `<start>` может превратиться в `<type1>`, `<type2>`, `<type3>` или в `<iceberg>`. Вероятность каждого варианта одинакова.

Допустим, мы получили токен `<type1>`. Посмотрим, во что может превратиться он:
```
	<type1>:
	- <0_8> <8_8> <8_8> <8_32> <water> <32_32> <32_8> <8_0>
```

Тут только один вариант. Зато какой! Из токена неминуемо получается целая цепочка других токенов. Причём `<water>` в свою очередь неминуемо превратится в `<0_0>`. Потому что такое правило в грамматике тоже есть.

И вот мы получили цепочку из каких-то циферок:
`<0_8> <8_8> <8_8> <8_32> <0_0> <32_32> <32_8> <8_0>`

Забегая вперёд, расскажу, что эти цифры означают верхние и нижние диаметры секций поплавка. Например у `<8_32>` верхний край тонюсенький, а нижний — пошире. А нулевой диаметр в `<8_0>` означает, что это самый нижний кусок и ниже уже ничего стоять не может.

Кажется, полученная последовательность токенов ни во что уже превратиться не может. А она может. Фокус в том, что часть правил грамматики создаётся скриптом в зависимости от того, какие секции поплавков нашлись во входном СВГ файле. Если бы мы записали их текстом, они были бы примерно такими:
```

```

Происходит этот так. Мы берём из входного СВГ все секции и запоминаем их в массиве. У каждого сегмента в массиве есть свой индекс, по которому его можно этот сегмент узнать и нарисовать на экране.

Для каждого сегмента мы добавляем в грамматику правило. Например, в массиве есть сегмент `p-8-8-100` с индексом `2`. При его обработке в грамматику добавится правило:
```
<8_8>
- 2
```

Допустим, таким образом мы автоматически добавили такие правила:
```
<0_8>
- 0
- 1
<8_8>
- 2
- 3
<8_32>
- 4
<0_0>
- 5
<32_32>
- 6
<32_8>
- 7
<8_0>
- 8
<0_0>
- 9
```

Допустим наша строка `<0_8> <8_8> <8_8> <8_32> <0_0> <32_32> <32_8> <8_0>` превратилась в `1 3 2 4 9 6 7 8`. Поскольку некоторые токены, например `<0_8>` имеют несколько вариантов превращения, итоговая последовательность могла бы выйти и немного другой.

Коллеги, поздравляю! Мы получили последовательность индексов секций. Теперь остаётся вытащить секции с такими индексами из массива и нарисовать их одну под другой. Дело техники.

## Вода и стрекоза


## Выравнивание по центру

## Итог

То есть, если вернуться к Жениным вопросам, ответы будут такие:

> Как из текста получается набор переменных. Сколько там переменных, как они связаны, как влияют на форму. 
Переменная одна, она делается из строки и является её хешем. То есть даже у почти одинаковых строк хеши будут сильно отличаться.

Эта переменная делает превращение стартового токена предсказуемым, определяя, какой из нескольких возможных способов превращения каждого токена будет выбран.

> Что такое грамматика, какая она.
It's breathtaking! They are all breathtaking! Некоторые люди даже генерят ими чистый СВГ.

> Как устроены все интеграции

> как был устроен процесс совместной разработки.

